

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>rhizome.api.resources.date_datapoint &mdash; rhizome  documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="rhizome  documentation" href="../../../../index.html"/>
        <link rel="up" title="Module code" href="../../../index.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        

        
          <a href="../../../../index.html" class="icon icon-home"> rhizome
        

        
        </a>

        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../about/index.html">About</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../about/background.html">Background</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../about/functionality.html">Core Functionality</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../about/functionality.html#uploader">Uploader</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../about/functionality.html#manage-system">Manage System</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../about/functionality.html#chart-builder">Chart Builder</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../about/functionality.html#dashboard-builder">Dashboard Builder</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../about/stack.html">Software Stack</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../about/stack.html#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../about/stack.html#deployment-environment">Deployment Environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../about/stack.html#development-environment">Development Environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../about/stack.html#testing-and-continuous-integration">Testing and Continuous Integration</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../back-end/index.html">Backend Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../back-end/data_model.html">Data Model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../back-end/data_model.html#datapoint-models">Datapoint Models</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../back-end/data_model.html#datapoint"><code class="docutils literal"><span class="pre">DataPoint</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../back-end/data_model.html#docdatapoint"><code class="docutils literal"><span class="pre">DocDataPoint</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../back-end/data_model.html#document-models">Document Models</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../back-end/data_model.html#document"><code class="docutils literal"><span class="pre">Document</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../back-end/data_model.html#sourcesubmission"><code class="docutils literal"><span class="pre">SourceSubmission</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../back-end/data_model.html#sourceobjectmap"><code class="docutils literal"><span class="pre">SourceObjectMap</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../back-end/data_model.html#indicator-models">Indicator Models</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../back-end/data_model.html#indicator"><code class="docutils literal"><span class="pre">Indicator</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../back-end/data_model.html#location-models">Location Models</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../back-end/data_model.html#location"><code class="docutils literal"><span class="pre">Location</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../back-end/data_model.html#locationpolygon"><code class="docutils literal"><span class="pre">LocationPolygon</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../back-end/data_model.html#campaign-models">Campaign Models</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../back-end/data_model.html#campaign"><code class="docutils literal"><span class="pre">Campaign</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../back-end/data_model.html#dashboard-models">Dashboard Models</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../back-end/data_model.html#custom-chart"><code class="docutils literal"><span class="pre">Custom</span> <span class="pre">Chart</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../back-end/data_model.html#custom-dashboard"><code class="docutils literal"><span class="pre">Custom</span> <span class="pre">Dashboard</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../back-end/migrations.html">Migrations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../back-end/build_docs.html">Creating the Documentation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../back-end/build_docs.html#building-back-end-documentation">Building back-end documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../back-end/build_docs.html#building-front-end-documentation">Building front-end documentation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../front-end/index.html">Front End Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../front-end/source_data.html">Source Data ( Technical )</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../front-end/manage_system.html">Manage System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../front-end/react_app.html">React App</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../testing/index.html">Unit Tests</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../testing/back_end.html">Backend Testing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../testing/back_end.html#running-tests">Running Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../testing/back_end.html#writing-tests">Writing Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../testing/back_end.html#module-rhizome.tests">Backend Test Source Code</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../testing/front_end.html">Front End</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../testing/front_end.html#running-tests">Running Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../testing/front_end.html#writing-tests">Writing Tests</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../testing/front_end.html#dont-s">Dont&#8217;s:</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../deployment/index.html">Deployment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../deployment/new_instance.html">New Install</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../deployment/new_instance.html#base-system-packages">Base System Packages</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../deployment/new_instance.html#basic-linux-packages">Basic Linux Packages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../deployment/new_instance.html#apache">Apache</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../deployment/new_instance.html#postgres">Postgres</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../deployment/new_instance.html#installing">Installing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../deployment/new_instance.html#adding-additional-linux-helper-packages">Adding additional Linux Helper Packages</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../deployment/new_instance.html#setting-up-users-and-creating-the-db">Setting up Users and Creating the DB</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../deployment/new_instance.html#serving-static-files">Serving Static files</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../deployment/push_code.html">Pushing Code</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../deployment/push_code.html#deploying">Deploying</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../deployment/push_code.html#releasing-to-master">Releasing to Master</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../deployment/restore_backup_db.html">Restoring and backing up a database</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../deployment/restore_backup_db.html#copying-a-database-from-prod-to-your-local">Copying a database from prod to your local</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../deployment/restore_backup_db.html#backup-db-script">backup db script</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../user-guide/index.html">User Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../user-guide/uploader.html">CSV / Excel File Uploader</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/uploader.html#uploading-data">Uploading Data</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../user-guide/uploader.html#requirements-for-uploading-documents">Requirements for Uploading Documents</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../user-guide/uploader.html#procedure-for-uploading-documents">Procedure for Uploading Documents</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user-guide/manage_system.html">Manage System</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/manage_system.html#indicators">Indicators</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../user-guide/manage_system.html#adding-tags">Adding Tags</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../user-guide/manage_system.html#adding-calculations">Adding Calculations</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user-guide/chart_builder.html">Chart Builder User Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user-guide/dashboard_builder.html">Dashboard Builder User Guide</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/index.html">API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/base_resources.html">Base Methods</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/base_resources.html#baseresource">BaseResource</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/base_resources.html#basenonmodelresource">BaseNonModelResource</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/base_resources.html#basemodelresource">BaseModelResource</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/base_resources.html#get-by-pk">GET (by PK)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/base_resources.html#get-with-query-filters">GET (with query filters)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/base_resources.html#post">POST</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/base_resources.html#patch">PATCH</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/base_resources.html#delete">DELETE</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/base_resources.html#get-schema">GET Schema</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/base_resources.html#get-locations-from-url">Get Locations From URL</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/datapoint_api.html">DataPoint API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/datapoint_api.html#api-v1-date-datapoint"><code class="docutils literal"><span class="pre">/api/v1/date_datapoint/</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/datapoint_api.html#api-v1-campaign-datapoint"><code class="docutils literal"><span class="pre">/api/v1/campaign_datapoint/</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/datapoint_api.html#response-format">Response Format</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/meta_resource_list.html">Core Application Resources</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/meta_resource_list.html#api-v1-all-meta"><code class="docutils literal"><span class="pre">/api/v1/all_meta/</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/meta_resource_list.html#response-format">Response Format</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/meta_resource_list.html#api-v1-geo"><code class="docutils literal"><span class="pre">/api/v1/geo/</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/meta_resource_list.html#id1">Response Format</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/meta_resource_list.html#api-v1-campaign"><code class="docutils literal"><span class="pre">/api/v1/campaign/</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/meta_resource_list.html#id2">Response Format</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/meta_resource_list.html#api-v1-custom-chart"><code class="docutils literal"><span class="pre">/api/v1/custom_chart/</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/meta_resource_list.html#id3">Response Format</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/meta_resource_list.html#api-v1-custom-dashboard"><code class="docutils literal"><span class="pre">/api/v1/custom_dashboard/</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/meta_resource_list.html#id4">Response Format</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/meta_resource_list.html#api-v1-location"><code class="docutils literal"><span class="pre">/api/v1/location/</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/meta_resource_list.html#id5">Response Format</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/meta_resource_list.html#api-v1-refresh-master"><code class="docutils literal"><span class="pre">/api/v1/refresh_master/</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/meta_resource_list.html#id6">Response Format</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/meta_resource_list.html#api-v1-source-doc"><code class="docutils literal"><span class="pre">/api/v1/source_doc/</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/meta_resource_list.html#id7">Response Format</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/meta_resource_list.html#api-v1-source-submission"><code class="docutils literal"><span class="pre">/api/v1/source_submission/</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/meta_resource_list.html#id8">Response Format</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/meta_resource_list.html#api-v1-transform-upload"><code class="docutils literal"><span class="pre">/api/v1/transform_upload/</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/meta_resource_list.html#id9">Response Format</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/debugging.html">Debugging the API</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../../index.html">rhizome</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
      
    <li>rhizome.api.resources.date_datapoint</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <h1>Source code for rhizome.api.resources.date_datapoint</h1><div class="highlight"><pre>
<span class="kn">from</span> <span class="nn">tastypie</span> <span class="kn">import</span> <span class="n">fields</span>
<span class="kn">from</span> <span class="nn">tastypie.resources</span> <span class="kn">import</span> <span class="n">ALL</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span>

<span class="kn">from</span> <span class="nn">rhizome.api.serialize</span> <span class="kn">import</span> <span class="n">CustomSerializer</span>
<span class="kn">from</span> <span class="nn">rhizome.api.resources.base_model</span> <span class="kn">import</span> <span class="n">BaseModelResource</span>
<span class="kn">from</span> <span class="nn">rhizome.api.exceptions</span> <span class="kn">import</span> <span class="n">RhizomeApiException</span>
<span class="kn">from</span> <span class="nn">rhizome.models.location_models</span> <span class="kn">import</span> <span class="n">Location</span><span class="p">,</span> <span class="n">LocationTree</span>
<span class="kn">from</span> <span class="nn">rhizome.models.document_models</span> <span class="kn">import</span> <span class="n">Document</span><span class="p">,</span> <span class="n">SourceSubmission</span>
<span class="kn">from</span> <span class="nn">rhizome.models.datapoint_models</span> <span class="kn">import</span> <span class="n">DataPoint</span>

<span class="kn">from</span> <span class="nn">rhizome.api</span> <span class="kn">import</span> <span class="n">custom_logic</span>


<div class="viewcode-block" id="DateDatapointResource"><a class="viewcode-back" href="../../../../api/datapoint_api.html#rhizome.api.resources.date_datapoint.DateDatapointResource">[docs]</a><span class="k">class</span> <span class="nc">DateDatapointResource</span><span class="p">(</span><span class="n">BaseModelResource</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    - **GET Requests:**</span>
<span class="sd">        - *Required Parameters:*</span>
<span class="sd">            &#39;indicator__in&#39; A comma-separated list of indicator IDs to fetch. By default, all indicators</span>
<span class="sd">            &#39;chart_type&#39;</span>
<span class="sd">        - *Optional Parameters:*</span>
<span class="sd">            &#39;location__in&#39; A comma-separated list of location IDs</span>
<span class="sd">            &#39;campaign_start&#39; format: ``YYYY-MM-DD``  Include only datapoints from campaigns that began on or after the supplied date</span>
<span class="sd">            &#39;campaign_end&#39; format: ``YYYY-MM-DD``  Include only datapoints from campaigns that ended on or before the supplied date</span>
<span class="sd">            &#39;campaign__in&#39;   A comma-separated list of campaign IDs. Only datapoints attached to one of the listed campaigns will be returned</span>
<span class="sd">            &#39;cumulative&#39;</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">indicator_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">attribute</span><span class="o">=</span><span class="s">&#39;indicator_id&#39;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">location_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">attribute</span><span class="o">=</span><span class="s">&#39;location_id&#39;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">(</span><span class="n">BaseModelResource</span><span class="o">.</span><span class="n">Meta</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        As this is a NON model resource, we must specify the object_class</span>
<span class="sd">        that will represent the data returned to the applicaton.  In this case</span>
<span class="sd">        as specified by the ResultObject the fields in our response will be</span>
<span class="sd">        location_id, campaign_id, indcator_json.</span>
<span class="sd">        The resource name is datapoint, which means this resource is accessed</span>
<span class="sd">        by /api/v1/datapoint/.</span>
<span class="sd">        The data is serialized by the CustomSerializer which uses the default</span>
<span class="sd">        handler for JSON responses and transforms the data to csv when the</span>
<span class="sd">        user clicks the &quot;download data&quot; button on the data explorer.</span>
<span class="sd">        note - authentication inherited from parent class</span>


<span class="sd">        # NOTE this needs to be cleaned up and any many of these methonds</span>
<span class="sd">        # should be executed by the parent ( base model resource )</span>
<span class="sd">        using the DataPoint as the object_class</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">resource_name</span> <span class="o">=</span> <span class="s">&#39;date_datapoint&#39;</span>  <span class="c"># cooresponds to the URL of the resource</span>
        <span class="n">GET_params_required</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;indicator__in&#39;</span><span class="p">]</span>
        <span class="n">object_class</span> <span class="o">=</span> <span class="n">DataPoint</span>
        <span class="n">required_fields_for_post</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;indicator_id&#39;</span><span class="p">,</span><span class="s">&#39;location_id&#39;</span><span class="p">,</span> <span class="s">&#39;data_date&#39;</span><span class="p">,</span> \
            <span class="s">&#39;value&#39;</span><span class="p">]</span>
        <span class="n">max_limit</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># return all rows by default ( limit defaults to 20 )</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">CustomSerializer</span><span class="p">()</span>
        <span class="n">filtering</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;indicator_id&#39;</span> <span class="p">:</span> <span class="n">ALL</span> <span class="p">,</span>
            <span class="s">&#39;location_id&#39;</span> <span class="p">:</span> <span class="n">ALL</span> <span class="p">,</span>
            <span class="s">&#39;data_date&#39;</span> <span class="p">:</span> <span class="n">ALL</span><span class="p">,</span>
            <span class="s">&#39;value&#39;</span>  <span class="p">:</span> <span class="n">ALL</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">campaign_id_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">distinct_time_groupings</span> <span class="o">=</span> <span class="p">[],[]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DateDatapointResource</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_default_post_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This needs work.. perhaps we can create one submission</span>
<span class="sd">        per session, so that wer can trace back to what a user entered at</span>
<span class="sd">        a particular time.</span>

<span class="sd">        Right now all data entry every where will be associated with one id</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">data_entry_doc_id</span> <span class="o">=</span> <span class="n">Document</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">doc_title</span> <span class="o">=</span> <span class="s">&#39;Data Entry&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">id</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">source_submission</span> <span class="o">=</span> <span class="n">SourceSubmission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">document_id</span> <span class="o">=</span> \
                <span class="n">data_entry_doc_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">source_submission</span> <span class="o">=</span> <span class="n">SourceSubmission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">document_id</span> <span class="o">=</span> \
                <span class="n">data_entry_doc_id</span><span class="p">,</span> <span class="n">row_number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;source_submission_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">source_submission</span><span class="o">.</span><span class="n">id</span>

        <span class="c">## now put the unique index on the bundle ##</span>
        <span class="n">unique_index</span> <span class="o">=</span> <span class="s">&#39;{}-{}-{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;location_id&#39;</span><span class="p">],</span>\
            <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;indicator_id&#39;</span><span class="p">],</span> <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;data_date&#39;</span><span class="p">])</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;unique_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unique_index</span>

        <span class="k">return</span> <span class="n">bundle</span>

    <span class="k">def</span> <span class="nf">get_response_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">objects</span><span class="p">):</span>

        <span class="n">meta</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">BaseModelResource</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">get_response_meta</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">objects</span><span class="p">)</span>

        <span class="n">chart_uuid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;chart_uuid&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">chart_uuid</span><span class="p">:</span>
            <span class="n">meta</span><span class="p">[</span><span class="s">&#39;chart_uuid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chart_uuid</span>

        <span class="n">ind_id_list</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;indicator__in&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">meta</span><span class="p">[</span><span class="s">&#39;location_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_ids</span><span class="p">]</span>
        <span class="n">meta</span><span class="p">[</span><span class="s">&#39;indicator_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ind_id_list</span><span class="p">]</span>
        <span class="n">meta</span><span class="p">[</span><span class="s">&#39;time_groupings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">distinct_time_groupings</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">meta</span>


    <span class="k">def</span> <span class="nf">apply_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">applicable_filters</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object_list</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_object_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This is where the action happens in this resource.  AFter passing the</span>
<span class="sd">        url paremeters, get the list of locations based on the parameters passed</span>
<span class="sd">        in the url as well as the permissions granted to the user responsible</span>
<span class="sd">        for the request.</span>
<span class="sd">        Using the location_ids from the get_locations_to_return_from_url method</span>
<span class="sd">        we query the datapoint abstracted table, then iterate through these</span>
<span class="sd">        values cleaning the indicator_json based in the indicator_ids passed</span>
<span class="sd">        in the url parameters, and creating a ResultObject for each row in the</span>
<span class="sd">        response.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">time_gb</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;group_by_time&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;start_date&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> \
            <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;campaign_start&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;end_date&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> \
            <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;campaign_end&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;location_id&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location_depth</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;location_depth&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">location_ids</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">location_ids</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;location_id__in&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">location_ids</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">location_ids</span> <span class="o">=</span> <span class="n">location_ids</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>

        <span class="n">indicator__in</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;indicator__in&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">indicator__in</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indicator__in</span> <span class="o">=</span> <span class="n">indicator__in</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dp_df_columns</span> <span class="o">=</span> \
            <span class="p">[</span><span class="s">&#39;data_date&#39;</span><span class="p">,</span> <span class="s">&#39;indicator_id&#39;</span><span class="p">,</span> <span class="s">&#39;location_id&#39;</span><span class="p">,</span> <span class="s">&#39;value&#39;</span><span class="p">]</span>

        <span class="n">group_by_param</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;group_by_time&#39;</span><span class="p">,</span> <span class="s">&#39;flat&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">group_by_param</span> <span class="o">==</span> <span class="s">&#39;flat&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">location_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_locations_to_return_from_url</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="n">DataPoint</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">location_id__in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_ids</span><span class="p">,</span>
                    <span class="n">indicator_id__in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicator__in</span><span class="p">,</span>
                    <span class="n">data_date__gte</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="p">,</span>
                    <span class="n">data_date__lte</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span>
                <span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dp_df_columns</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">qs</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">base_data_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_by_time_transform</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="c">## if no datapoints, we return an empty list#</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_data_df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_data_df</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s">&#39;records&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_time_group_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dp_df</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">dp_df</span><span class="p">[</span><span class="s">&#39;data_date&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RhizomeApiException</span><span class="p">(</span><span class="s">&#39;This is a campaign (not date) indicator&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_gb</span> <span class="o">==</span> <span class="s">&#39;year&#39;</span><span class="p">:</span>
            <span class="n">dp_df</span><span class="p">[</span><span class="s">&#39;time_grouping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dp_df</span><span class="p">[</span>
                <span class="s">&#39;data_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">year</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_gb</span> <span class="o">==</span> <span class="s">&#39;quarter&#39;</span><span class="p">:</span>
            <span class="n">dp_df</span><span class="p">[</span><span class="s">&#39;time_grouping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dp_df</span><span class="p">[</span><span class="s">&#39;data_date&#39;</span><span class="p">]</span>\
                <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">year</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">month</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_gb</span> <span class="o">==</span> <span class="s">&#39;all_time&#39;</span><span class="p">:</span>
            <span class="n">dp_df</span><span class="p">[</span><span class="s">&#39;time_grouping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dp_df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>

        <span class="c">## find the unique possible groupings for this time range and gb param</span>
        <span class="c">## sketchy -- this wont work for quarter groupingings, only years.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distinct_time_groupings</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dp_df</span><span class="o">.</span><span class="n">time_grouping</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">distinct_time_groupings</span><span class="p">:</span>
            <span class="n">start_yr</span><span class="p">,</span> <span class="n">end_yr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">distinct_time_groupings</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">start_yr</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">end_yr</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">dp_df</span>

    <span class="k">def</span> <span class="nf">handle_discrete_location_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">discret_loc_dp_df_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dp_df_columns</span>
        <span class="n">discret_loc_dp_df_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span>

        <span class="n">dp_df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">DataPoint</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">location_id__in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_ids</span><span class="p">,</span>
                <span class="n">indicator_id__in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicator__in</span><span class="p">,</span>
                <span class="n">data_date__gte</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="p">,</span>
                <span class="n">data_date__lte</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span>
            <span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="o">*</span><span class="n">discret_loc_dp_df_cols</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dp_df_columns</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dp_df</span>


    <span class="k">def</span> <span class="nf">group_by_time_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Imagine the following location tree heirarchy</span>
<span class="sd">            ( Country -&gt; Region -&gt; Province -&gt; District )</span>

<span class="sd">            Based on these two queries return the coorseponding result</span>
<span class="sd">                1. Show Polio cases in Afghanistan with a bubble on each</span>
<span class="sd">                    province</span>
<span class="sd">                2. Show Polio cases in Afghanistan with a bubble on each</span>
<span class="sd">                    district</span>
<span class="sd">                2. Show Polio cases in the southern Region with a bubble</span>
<span class="sd">                    on each district</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c"># FIXME - remove this guid and figure out better logic for this</span>
        <span class="n">chart_uuid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;chart_uuid&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">chart_uuid</span> <span class="ow">and</span> <span class="n">chart_uuid</span> <span class="o">==</span> <span class="s">&#39;5599c516-d2be-4ed0-ab2c-d9e7e5fe33be&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">custom_logic</span><span class="o">.</span><span class="n">handle_polio_case_table</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_discrete_location_request</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">loc_tree_df_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;parent_location_id&#39;</span><span class="p">,</span><span class="s">&#39;location_id&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">location_ids</span> <span class="o">=</span> <span class="n">LocationTree</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">parent_location_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_id</span><span class="p">,</span>
                <span class="n">lvl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_depth</span>
            <span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;location_id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="c"># ## this is a hack to deal with this ticket ##</span>
            <span class="c"># # https://trello.com/c/No82UpGl</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">location_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">location_ids</span> <span class="o">=</span> <span class="n">Location</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">parent_location_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">location_id</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="n">loc_tree_df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">LocationTree</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">parent_location_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_ids</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="o">*</span><span class="n">loc_tree_df_columns</span><span class="p">)),</span><span class="n">columns</span> <span class="o">=</span> <span class="n">loc_tree_df_columns</span><span class="p">)</span>

            <span class="n">dp_loc_ids</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">location_id</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_depth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">dp_loc_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">loc_tree_df</span><span class="p">[</span><span class="s">&#39;location_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

            <span class="n">dp_df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">DataPoint</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">location_id__in</span> <span class="o">=</span> <span class="n">dp_loc_ids</span><span class="p">,</span>
                    <span class="n">indicator_id__in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicator__in</span><span class="p">,</span>
                    <span class="n">data_date__gte</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="p">,</span>
                    <span class="n">data_date__lte</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span>
                <span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dp_df_columns</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dp_df_columns</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dp_df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">dp_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time_group_series</span><span class="p">(</span><span class="n">dp_df</span><span class="p">)</span>
        <span class="n">merged_df</span> <span class="o">=</span> <span class="n">dp_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">loc_tree_df</span><span class="p">)</span>

        <span class="c">## sum all values for locations with the same parent location</span>
        <span class="n">gb_df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">merged_df</span>
              <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">&#39;indicator_id&#39;</span><span class="p">,</span> <span class="s">&#39;time_grouping&#39;</span><span class="p">,</span> <span class="s">&#39;parent_location_id&#39;</span><span class="p">])[</span><span class="s">&#39;value&#39;</span><span class="p">]</span>
              <span class="o">.</span><span class="n">sum</span><span class="p">())</span>\
              <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="n">gb_df</span> <span class="o">=</span> <span class="n">gb_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
            <span class="s">&#39;parent_location_id&#39;</span><span class="p">:</span> <span class="s">&#39;location_id&#39;</span><span class="p">,</span>
            <span class="p">})</span>

        <span class="n">gb_df</span> <span class="o">=</span> <span class="n">gb_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;parent_location_id&#39;</span><span class="p">:</span> <span class="s">&#39;location_id&#39;</span><span class="p">})</span>
        <span class="n">gb_df</span> <span class="o">=</span> <span class="n">gb_df</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="s">&#39;time_grouping&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">gb_df</span></div>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>